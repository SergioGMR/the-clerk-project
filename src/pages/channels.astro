---
import Layout from "@layouts/Layout.astro";
import { getChannels, getChannelUrl } from "@utils/channelScraper";

// Obtener los canales
const channels = await getChannels();

// Agrupar por groupTitle (títulos de h5)
const channelsByGroup = channels.reduce(
    (acc, channel) => {
        if (!channel.groupTitle) return acc;

        if (!acc[channel.groupTitle]) {
            acc[channel.groupTitle] = [];
        }
        acc[channel.groupTitle].push(channel);
        return acc;
    },
    {} as Record<string, typeof channels>,
);

// Ordenar títulos de grupos alfabéticamente
const sortedGroups = Object.keys(channelsByGroup).sort();
---

<Layout title="Canales por Categoría | Acestream Directory">
    <div class="py-8 px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold text-white mb-6">
            Canales Organizados por Categoría
        </h1>

        <div class="space-y-8">
            {
                sortedGroups.map((groupTitle) => (
                    <div class="bg-zinc-900 border border-zinc-800 rounded-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-zinc-800 to-zinc-900 px-6 py-4 border-b border-zinc-700">
                            <h2 class="text-xl font-medium text-white">
                                {groupTitle}
                            </h2>
                            <p class="text-zinc-400 text-sm mt-1">
                                {channelsByGroup[groupTitle].length} canales
                                disponibles
                            </p>
                        </div>

                        <div class="p-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                {channelsByGroup[groupTitle].map((channel) => (
                                    <a
                                        href={getChannelUrl(channel)}
                                        target={
                                            channel.type === "url"
                                                ? "_blank"
                                                : "_self"
                                        }
                                        rel={
                                            channel.type === "url"
                                                ? "noopener noreferrer"
                                                : ""
                                        }
                                        class="bg-zinc-800/50 border border-zinc-700/50 rounded-lg p-3 hover:bg-zinc-800 hover:border-zinc-700 transition-colors flex items-center"
                                    >
                                        <div class="flex-shrink-0 w-10 h-10 rounded-md bg-zinc-700 flex items-center justify-center">
                                            {channel.type === "acestream" ? (
                                                <svg
                                                    class="w-5 h-5 text-red-500"
                                                    fill="currentColor"
                                                    viewBox="0 0 20 20"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                >
                                                    <path d="M14.414 7l3.293-3.293a1 1 0 00-1.414-1.414L13 5.586V4a1 1 0 10-2 0v4.003a.996.996 0 00.617.921A.997.997 0 0012 9h4a1 1 0 100-2h-1.586z" />
                                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                                </svg>
                                            ) : (
                                                <svg
                                                    class="w-5 h-5 text-blue-500"
                                                    fill="currentColor"
                                                    viewBox="0 0 20 20"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                >
                                                    <path
                                                        fill-rule="evenodd"
                                                        d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z"
                                                        clip-rule="evenodd"
                                                    />
                                                </svg>
                                            )}
                                        </div>
                                        <div class="ml-3 flex-1 overflow-hidden">
                                            <h3 class="text-white font-medium text-sm truncate">
                                                {channel.name}
                                            </h3>
                                            <div class="flex gap-1 mt-1">
                                                {channel.quality && (
                                                    <span class="inline-block px-2 py-0.5 text-xs rounded bg-green-900/50 text-green-300 border border-green-800/50">
                                                        {channel.quality}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </a>
                                ))}
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>

        <div class="mt-8 text-center">
            <a
                href="/channels"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
            >
                Ver listado completo de canales
            </a>
        </div>
    </div>
</Layout>

<script>
    import { setupAcestreamHandlers } from "../scripts/channelFilters.js";

    // Set up acestream handlers for mobile devices
    setupAcestreamHandlers();
</script>
